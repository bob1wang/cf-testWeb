<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>习题导入与测验工具 V3.0 (多题库版)</title>

    <meta name="description" content="一个支持多题库管理的在线学习工具，可以从本地JSON文件导入题库进行学习和测验。">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧠</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { -webkit-backface-visibility: hidden; backface-visibility: hidden; }
        .flip-card-back { transform: rotateY(180deg); }
        .code-block { background-color: #f7fafc; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; font-size: 0.875rem; color: #2d3748; }
        .dark .code-block { background-color: #1a202c; border-color: #4a5568; color: #cbd5e0; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

<div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
    <header class="text-center mb-8">
        <h1 id="main-title" class="text-4xl font-bold text-blue-600 dark:text-blue-400">习题测验工具 V3.0</h1>
        <p class="mt-2 text-lg text-slate-600 dark:text-slate-400">支持多题库管理，高效学习与自测。</p>
    </header>

    <main class="space-y-8">
        <!-- 题库管理 -->
        <section id="deck-management-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">题库管理</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div>
                    <label for="bank-selector" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">当前题库:</label>
                    <select id="bank-selector" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4 md:mt-0 md:justify-end">
                    <button id="import-file-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        从文件导入
                    </button>
                    <input type="file" id="file-input" class="hidden" accept=".json">
                </div>
            </div>
            <p id="local-load-status" class="text-xs text-slate-500 mt-3"></p>
        </section>

        <!-- 学习与测验区域 -->
        <section id="study-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b border-slate-200 dark:border-slate-700 pb-4">
                <h2 class="text-2xl font-semibold">开始学习</h2>
                <div class="flex items-center space-x-3 mt-4 sm:mt-0">
                    <label for="filter-review-toggle" class="flex items-center cursor-pointer text-sm font-medium">
                        <input type="checkbox" id="filter-review-toggle" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-slate-700 dark:text-slate-300">仅显示标记</span>
                    </label>
                </div>
            </div>

            <div id="card-container" class="min-h-[250px] flex items-center justify-center perspective-1000">
                <div id="flip-card" class="flip-card w-full h-full">
                    <div class="flip-card-inner relative w-full h-full">
                        <div class="flip-card-front absolute w-full h-full bg-slate-50 dark:bg-slate-700 rounded-lg p-6 flex flex-col justify-center items-center">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">问题</p>
                            <p id="question-display" class="text-xl md:text-2xl text-center font-semibold"></p>
                        </div>
                        <div class="flip-card-back absolute w-full h-full bg-green-50 dark:bg-green-900/50 rounded-lg p-6 flex flex-col justify-center items-center">
                            <p class="text-xs text-green-600 dark:text-green-400 mb-2">答案</p>
                            <p id="answer-display" class="text-xl md:text-2xl text-center font-semibold text-green-800 dark:text-green-200"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button id="show-answer-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105">查看答案</button>
            </div>

            <div class="flex justify-between items-center mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                <button id="prev-btn" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition">&lt; 上一题</button>
                <p id="progress-indicator" class="text-sm font-medium text-slate-600 dark:text-slate-400">0 / 0</p>
                <button id="next-btn" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition">下一题 &gt;</button>
            </div>
            <div class="flex justify-center items-center space-x-4 mt-4">
                <button id="mark-review-btn" class="px-5 py-2 text-sm bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800/60 rounded-lg transition">⭐ 标记复习</button>
                <button id="random-btn" class="px-5 py-2 text-sm bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800/60 rounded-lg transition">随机一题</button>
            </div>
        </section>

        <!-- 粘贴导入区域 -->
        <section id="import-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">或粘贴内容以追加题库</h2>
            <textarea id="data-input" rows="8" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition font-mono text-sm" placeholder="在此处粘贴您的JSON格式题库..."></textarea>
            <button id="import-text-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">追加为新题库</button>
            <p id="import-status" class="text-sm mt-2 h-5"></p>
        </section>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const mainTitle = document.getElementById('main-title');
        const bankSelector = document.getElementById('bank-selector');
        const importFileBtn = document.getElementById('import-file-btn');
        const fileInput = document.getElementById('file-input');
        const dataInput = document.getElementById('data-input');
        const importTextBtn = document.getElementById('import-text-btn');
        const importStatus = document.getElementById('import-status');
        const localLoadStatus = document.getElementById('local-load-status');
        const studySection = document.getElementById('study-section');
        const questionDisplay = document.getElementById('question-display');
        const answerDisplay = document.getElementById('answer-display');
        const progressIndicator = document.getElementById('progress-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const randomBtn = document.getElementById('random-btn');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const flipCard = document.getElementById('flip-card');
        const markReviewBtn = document.getElementById('mark-review-btn');
        const filterReviewToggle = document.getElementById('filter-review-toggle');

        // --- App State ---
        let questionBanks = {};
        let activeBankName = null;
        let displayedQuestions = [];
        let currentIndex = 0;

        // --- Core Functions ---
        function addBank(name, questions) {
            if (!Array.isArray(questions) || questions.some(q => typeof q.question === 'undefined' || typeof q.answer === 'undefined')) {
                showStatus(`题库 "${name}" 格式错误，已跳过。`, 'error');
                return false;
            }
            const cleanName = name.replace('.json', '');
            questionBanks[cleanName] = questions.map(q => ({ ...q, review: false }));
            updateBankSelector();
            setActiveBank(cleanName);
            return true;
        }

        function setActiveBank(name) {
            if (!questionBanks[name]) return;
            activeBankName = name;
            bankSelector.value = name;
            mainTitle.textContent = `学习中: ${name}`;
            updateDisplayedQuestions();
        }

        function updateBankSelector() {
            bankSelector.innerHTML = '';
            for (const name in questionBanks) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${questionBanks[name].length}题)`;
                bankSelector.appendChild(option);
            }
            bankSelector.value = activeBankName;
        }

        function updateDisplayedQuestions() {
            if (!activeBankName || !questionBanks[activeBankName]) {
                displayedQuestions = [];
            } else {
                const bank = questionBanks[activeBankName];
                displayedQuestions = filterReviewToggle.checked ? bank.filter(q => q.review) : bank;
            }
            currentIndex = 0;
            displayQuestion();
        }

        function displayQuestion() {
            flipCard.classList.remove('flipped');
            showAnswerBtn.textContent = '查看答案';

            if (displayedQuestions.length === 0) {
                let msg = '请先导入或选择一个题库。';
                if (activeBankName) {
                    msg = filterReviewToggle.checked ? '没有标记为复习的题目。' : '该题库为空。';
                }
                questionDisplay.textContent = msg;
                answerDisplay.textContent = '...';
                progressIndicator.textContent = '0 / 0';
                markReviewBtn.disabled = true;
                return;
            }

            markReviewBtn.disabled = false;
            const card = displayedQuestions[currentIndex];
            questionDisplay.textContent = card.question;
            answerDisplay.textContent = card.answer;
            progressIndicator.textContent = `${currentIndex + 1} / ${displayedQuestions.length}`;
            updateMarkButtonUI();
        }

        function updateMarkButtonUI() {
            if (displayedQuestions.length === 0) return;
            const card = displayedQuestions[currentIndex];
            if (card.review) {
                markReviewBtn.textContent = '⭐ 取消标记';
                markReviewBtn.classList.replace('bg-amber-100', 'bg-amber-300');
            } else {
                markReviewBtn.textContent = '⭐ 标记复习';
                markReviewBtn.classList.replace('bg-amber-300', 'bg-amber-100');
            }
        }

        function showStatus(message, type = 'success') {
            importStatus.textContent = message;
            const colors = { success: 'text-green-600 dark:text-green-400', error: 'text-red-600 dark:text-red-400' };
            importStatus.className = `text-sm mt-2 h-5 ${colors[type]}`;
            setTimeout(() => { importStatus.textContent = ''; }, 4000);
        }

        // --- Event Listeners ---
        importFileBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const questions = JSON.parse(e.target.result);
                    if (addBank(file.name, questions)) {
                        showStatus(`成功导入题库 "${file.name}"`, 'success');
                    }
                } catch (err) {
                    showStatus(`导入失败: ${err.message}`, 'error');
                }
            };
            reader.readAsText(file);
            fileInput.value = ''; // Reset for next import
        });

        importTextBtn.addEventListener('click', () => {
            const rawData = dataInput.value.trim();
            if (!rawData) {
                showStatus('文本框内容为空！', 'error');
                return;
            }
            try {
                const questions = JSON.parse(rawData);
                const bankName = `粘贴题库_${new Date().toLocaleTimeString()}`;
                if(addBank(bankName, questions)){
                    dataInput.value = '';
                    showStatus(`成功添加 "${bankName}"`, 'success');
                }
            } catch (err) {
                showStatus(`解析失败: ${err.message}`, 'error');
            }
        });

        bankSelector.addEventListener('change', (e) => setActiveBank(e.target.value));
        filterReviewToggle.addEventListener('change', updateDisplayedQuestions);

        markReviewBtn.addEventListener('click', () => {
            if (displayedQuestions.length === 0) return;
            const card = displayedQuestions[currentIndex];
            card.review = !card.review;
            updateMarkButtonUI();
            if (filterReviewToggle.checked && !card.review) {
                updateDisplayedQuestions();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (displayedQuestions.length === 0) return;
            currentIndex = (currentIndex + 1) % displayedQuestions.length;
            displayQuestion();
        });

        prevBtn.addEventListener('click', () => {
            if (displayedQuestions.length === 0) return;
            currentIndex = (currentIndex - 1 + displayedQuestions.length) % displayedQuestions.length;
            displayQuestion();
        });

        randomBtn.addEventListener('click', () => {
            if (displayedQuestions.length <= 1) return;
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * displayedQuestions.length);
            } while (newIndex === currentIndex);
            currentIndex = newIndex;
            displayQuestion();
        });

        showAnswerBtn.addEventListener('click', () => {
            flipCard.classList.toggle('flipped');
            showAnswerBtn.textContent = flipCard.classList.contains('flipped') ? '隐藏答案' : '查看答案';
        });

        // --- Initialization ---
        async function initialize() {
            try {
                const response = await fetch('default-questions.json');
                if (!response.ok) throw new Error('网络响应不佳');
                const questions = await response.json();
                addBank('default-questions', questions);
                localLoadStatus.textContent = 'ⓘ 已成功加载本地默认题库。您可将其他 .json 文件置于同目录下并刷新页面进行加载(需本地服务器环境)。';
            } catch (error) {
                console.warn('无法加载本地默认题库:', error);
                localLoadStatus.textContent = 'ⓘ 未找到本地默认题库 (default-questions.json)。请通过上方按钮导入。';
                displayQuestion();
            }
        }

        initialize();
    });
</script>
</body>
</html>


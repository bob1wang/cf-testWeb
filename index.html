<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ é¢˜æµ‹éªŒå·¥å…· V5.0 (ç®€åŒ–ç‰ˆ)</title>

    <meta name="description" content="ä¸€ä¸ªæ”¯æŒå¤šé¢˜åº“ç®¡ç†çš„åœ¨çº¿å­¦ä¹ å·¥å…·ï¼Œå¯ä»¥ä»æœ¬åœ°JSONæ–‡ä»¶å¯¼å…¥é¢˜åº“è¿›è¡Œå­¦ä¹ å’Œæµ‹éªŒã€‚">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
        }
        .dark body {
            background-color: #0b1120;
        }
        .flip-card {
            cursor: pointer;
        }
        .flip-card-inner { transition: transform 0.7s cubic-bezier(0.25, 1, 0.5, 1); transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { -webkit-backface-visibility: hidden; backface-visibility: hidden; }
        .flip-card-back { transform: rotateY(180deg); }
        .card-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 0.75rem; /* 12px */
            background: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.1), transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 0;
        }
        .dark .card-glow::before {
            background: radial-gradient(circle at 50% 0%, rgba(96, 165, 250, 0.15), transparent 70%);
        }
        .flip-card:hover .card-glow::before {
            opacity: 1;
        }
    </style>
</head>
<body class="dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

<div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
    <header class="text-center mb-8">
        <h1 id="main-title" class="text-4xl font-bold text-blue-600 dark:text-blue-400">ä¹ é¢˜æµ‹éªŒå·¥å…· V5.0</h1>
        <p class="mt-2 text-lg text-slate-600 dark:text-slate-400">æ”¯æŒå¤šé¢˜åº“ç®¡ç†ï¼Œé«˜æ•ˆå­¦ä¹ ä¸è‡ªæµ‹ã€‚</p>
    </header>

    <main class="space-y-8">
        <!-- é¢˜åº“ç®¡ç† -->
        <section class="bg-white dark:bg-slate-800/50 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-semibold mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">é¢˜åº“ç®¡ç†</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div>
                    <label for="bank-selector" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">å½“å‰é¢˜åº“:</label>
                    <select id="bank-selector" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4 md:mt-0 md:justify-end">
                    <button id="import-file-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        <span>ä»æ–‡ä»¶å¯¼å…¥</span>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept=".json">
                </div>
            </div>
            <p id="local-load-status" class="text-xs text-slate-500 mt-3"></p>
        </section>

        <!-- å­¦ä¹ ä¸æµ‹éªŒåŒºåŸŸ -->
        <section class="bg-white dark:bg-slate-800/50 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                <h2 class="text-2xl font-semibold">å¼€å§‹å­¦ä¹ </h2>
                <label for="filter-review-toggle" class="flex items-center cursor-pointer text-sm font-medium mt-4 sm:mt-0">
                    <input type="checkbox" id="filter-review-toggle" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-slate-700 dark:text-slate-300">ä»…æ˜¾ç¤ºæ ‡è®°</span>
                </label>
            </div>

            <div id="card-container" class="perspective-1000">
                <div id="flip-card" class="flip-card w-full relative" style="transition: height 0.3s ease-in-out;">
                    <div class="flip-card-inner relative w-full h-full card-glow">
                        <!-- Card Front (Question) -->
                        <div id="card-front" class="flip-card-front absolute w-full h-full bg-slate-50 dark:bg-slate-800 rounded-xl p-6 flex flex-col justify-center items-center shadow-md border border-slate-200 dark:border-slate-700 min-h-[300px]">
                            <span class="text-sm font-medium text-blue-500 dark:text-blue-400 mb-4">é—®é¢˜</span>
                            <p id="question-display" class="text-xl md:text-2xl text-center font-semibold text-slate-800 dark:text-slate-100"></p>
                        </div>
                        <!-- Card Back (Answer) -->
                        <div id="card-back" class="flip-card-back absolute w-full h-full bg-emerald-50 dark:bg-emerald-900/40 rounded-xl p-6 flex flex-col justify-center items-center shadow-md border border-emerald-200 dark:border-emerald-800 min-h-[300px]">
                            <span class="text-sm font-medium text-emerald-600 dark:text-emerald-400 mb-4">ç­”æ¡ˆ</span>
                            <p id="answer-display" class="text-lg md:text-xl text-center font-normal text-slate-700 dark:text-slate-200 leading-relaxed"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
                <button id="prev-btn" class="p-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-full transition-all duration-200 ease-in-out transform hover:scale-110" aria-label="ä¸Šä¸€é¢˜">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <p id="progress-indicator" class="text-sm font-medium text-slate-600 dark:text-slate-400">0 / 0</p>
                <button id="next-btn" class="p-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-full transition-all duration-200 ease-in-out transform hover:scale-110" aria-label="ä¸‹ä¸€é¢˜">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div class="flex justify-center items-center space-x-4 mt-4">
                <button id="mark-review-btn" class="px-5 py-2 text-sm bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800/60 rounded-lg transition-all duration-200 ease-in-out">â­ æ ‡è®°å¤ä¹ </button>
                <button id="random-btn" class="px-5 py-2 text-sm bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800/60 rounded-lg transition-all duration-200 ease-in-out">éšæœºä¸€é¢˜</button>
            </div>
        </section>

        <section class="bg-white dark:bg-slate-800/50 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-semibold mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">ç²˜è´´å†…å®¹ä»¥è¿½åŠ é¢˜åº“</h2>
            <textarea id="data-input" rows="8" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
            <button id="import-text-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105">è¿½åŠ ä¸ºæ–°é¢˜åº“</button>
            <p id="import-status" class="text-sm mt-2 h-5"></p>
        </section>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const mainTitle = document.getElementById('main-title');
        const bankSelector = document.getElementById('bank-selector');
        const importFileBtn = document.getElementById('import-file-btn');
        const fileInput = document.getElementById('file-input');
        const dataInput = document.getElementById('data-input');
        const importTextBtn = document.getElementById('import-text-btn');
        const importStatus = document.getElementById('import-status');
        const localLoadStatus = document.getElementById('local-load-status');
        const questionDisplay = document.getElementById('question-display');
        const answerDisplay = document.getElementById('answer-display');
        const progressIndicator = document.getElementById('progress-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const randomBtn = document.getElementById('random-btn');
        const flipCard = document.getElementById('flip-card');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const markReviewBtn = document.getElementById('mark-review-btn');
        const filterReviewToggle = document.getElementById('filter-review-toggle');

        // --- App State ---
        let questionBanks = {};
        let activeBankName = null;
        let displayedQuestions = [];
        let currentIndex = 0;

        // --- Adjust Card Height Function ---
        function adjustCardHeight() {
            if (!flipCard.isConnected) return; // Prevent errors if element is gone

            requestAnimationFrame(() => {
                if (displayedQuestions.length === 0) {
                    flipCard.style.height = '300px';
                    return;
                }

                const frontHeight = cardFront.scrollHeight;
                const backHeight = cardBack.scrollHeight;

                const newHeight = Math.max(frontHeight, backHeight, 300); // Minimum height of 300px

                flipCard.style.height = `${newHeight}px`;
            });
        }

        // --- Core Functions ---
        function addBank(name, questions) {
            if (!Array.isArray(questions) || (questions.length > 0 && questions.some(q => typeof q.question === 'undefined' || typeof q.answer === 'undefined'))) {
                showStatus(`é¢˜åº“ "${name}" æ ¼å¼é”™è¯¯ï¼Œå·²è·³è¿‡ã€‚`, 'error');
                return false;
            }
            const cleanName = name.replace(/\.json$/i, '');
            questionBanks[cleanName] = questions.map(q => ({ ...q, review: false }));
            updateBankSelector();
            setActiveBank(cleanName);
            return true;
        }

        function setActiveBank(name) {
            if (!questionBanks[name]) return;
            activeBankName = name;
            bankSelector.value = name;
            mainTitle.textContent = `å­¦ä¹ ä¸­: ${name}`;
            updateDisplayedQuestions();
        }

        function updateBankSelector() {
            bankSelector.innerHTML = '';
            const names = Object.keys(questionBanks);
            if(names.length === 0) {
                const option = document.createElement('option');
                option.textContent = "è¯·å…ˆå¯¼å…¥é¢˜åº“";
                bankSelector.appendChild(option);
                bankSelector.disabled = true;
            } else {
                bankSelector.disabled = false;
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${questionBanks[name].length}é¢˜)`;
                    bankSelector.appendChild(option);
                });
            }
            bankSelector.value = activeBankName;
        }

        function updateDisplayedQuestions() {
            if (!activeBankName || !questionBanks[activeBankName]) {
                displayedQuestions = [];
            } else {
                const bank = questionBanks[activeBankName];
                displayedQuestions = filterReviewToggle.checked ? bank.filter(q => q.review) : [...bank];
            }
            currentIndex = 0;
            displayQuestion();
        }

        function formatAnswer(text) {
            if (!text) return '';
            const regex = /(ï¼ˆ\d+ï¼‰|\(\d+\)|\d+\.\s?)/g;
            return text.replace(regex, (match, _, offset) => {
                return offset === 0 ? match : `<br>${match}`;
            });
        }

        function displayQuestion() {
            flipCard.classList.remove('flipped');

            if (displayedQuestions.length === 0) {
                let msg = 'è¯·å…ˆå¯¼å…¥æˆ–é€‰æ‹©ä¸€ä¸ªé¢˜åº“ã€‚';
                if (activeBankName) {
                    msg = filterReviewToggle.checked ? 'æ²¡æœ‰æ ‡è®°ä¸ºå¤ä¹ çš„é¢˜ç›®ã€‚' : 'è¯¥é¢˜åº“ä¸ºç©ºæˆ–æœªé€‰æ‹©ã€‚';
                }
                cardFront.innerHTML = `<div class="text-center text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 opacity-50"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <p>${msg}</p>
                </div>`;
                questionDisplay.textContent = '';
                answerDisplay.innerHTML = '';
                progressIndicator.textContent = '0 / 0';
                markReviewBtn.disabled = true;
                adjustCardHeight(); // Adjust for empty state
                return;
            }

            if (!document.getElementById('question-display')) {
                cardFront.innerHTML = `<span class="text-sm font-medium text-blue-500 dark:text-blue-400 mb-4">é—®é¢˜</span>
                                     <p id="question-display" class="text-xl md:text-2xl text-center font-semibold text-slate-800 dark:text-slate-100"></p>`;
            }

            markReviewBtn.disabled = false;
            const card = displayedQuestions[currentIndex];
            const qDisplay = document.getElementById('question-display');
            if(qDisplay) qDisplay.textContent = card.question;
            answerDisplay.innerHTML = formatAnswer(card.answer);
            progressIndicator.textContent = `${currentIndex + 1} / ${displayedQuestions.length}`;
            updateMarkButtonUI();

            setTimeout(adjustCardHeight, 50);
        }

        function updateMarkButtonUI() {
            if (displayedQuestions.length === 0) return;
            const card = displayedQuestions[currentIndex];
            if (card.review) {
                markReviewBtn.textContent = 'â­ å–æ¶ˆæ ‡è®°';
                markReviewBtn.classList.add('bg-amber-300', 'dark:bg-amber-600');
                markReviewBtn.classList.remove('bg-amber-100', 'dark:bg-amber-900/50');
            } else {
                markReviewBtn.textContent = 'â­ æ ‡è®°å¤ä¹ ';
                markReviewBtn.classList.remove('bg-amber-300', 'dark:bg-amber-600');
                markReviewBtn.classList.add('bg-amber-100', 'dark:bg-amber-900/50');
            }
        }

        function showStatus(message, type = 'success') {
            importStatus.textContent = message;
            const colors = { success: 'text-green-600 dark:text-green-400', error: 'text-red-600 dark:text-red-400' };
            importStatus.className = `text-sm mt-2 h-5 ${colors[type]}`;
            setTimeout(() => { importStatus.textContent = ''; }, 4000);
        }

        // --- Event Listeners ---
        importFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const questions = JSON.parse(e.target.result);
                    if (addBank(file.name, questions)) {
                        showStatus(`æˆåŠŸå¯¼å…¥é¢˜åº“ "${file.name.replace(/\.json$/i, '')}"`, 'success');
                    }
                } catch (err) { showStatus(`å¯¼å…¥å¤±è´¥: ${err.message}`, 'error'); }
            };
            reader.readAsText(file);
            fileInput.value = '';
        });

        importTextBtn.addEventListener('click', () => {
            const rawData = dataInput.value.trim();
            if (!rawData) { showStatus('æ–‡æœ¬æ¡†å†…å®¹ä¸ºç©ºï¼', 'error'); return; }
            try {
                const questions = JSON.parse(rawData);
                const bankName = `ç²˜è´´é¢˜åº“_${new Date().toLocaleTimeString()}`;
                if(addBank(bankName, questions)){
                    dataInput.value = '';
                    showStatus(`æˆåŠŸæ·»åŠ  "${bankName}"`, 'success');
                }
            } catch (err) { showStatus(`è§£æå¤±è´¥: ${err.message}`, 'error'); }
        });

        bankSelector.addEventListener('change', (e) => setActiveBank(e.target.value));
        filterReviewToggle.addEventListener('change', updateDisplayedQuestions);

        markReviewBtn.addEventListener('click', () => {
            if (displayedQuestions.length === 0) return;
            const originalIndex = questionBanks[activeBankName].findIndex(q => q.question === displayedQuestions[currentIndex].question);
            if(originalIndex > -1) {
                questionBanks[activeBankName][originalIndex].review = !questionBanks[activeBankName][originalIndex].review;
            }
            updateMarkButtonUI();
            if (filterReviewToggle.checked && !displayedQuestions[currentIndex].review) {
                setTimeout(() => updateDisplayedQuestions(), 200);
            }
        });

        const navigate = (direction) => {
            if (displayedQuestions.length === 0) return;
            currentIndex = (currentIndex + direction + displayedQuestions.length) % displayedQuestions.length;
            displayQuestion();
        };

        nextBtn.addEventListener('click', () => navigate(1));
        prevBtn.addEventListener('click', () => navigate(-1));
        randomBtn.addEventListener('click', () => {
            if (displayedQuestions.length <= 1) return;
            let newIndex;
            do { newIndex = Math.floor(Math.random() * displayedQuestions.length); } while (newIndex === currentIndex);
            currentIndex = newIndex;
            displayQuestion();
        });

        flipCard.addEventListener('click', () => {
            if (displayedQuestions.length > 0) {
                flipCard.classList.toggle('flipped');
            }
        });

        window.addEventListener('resize', adjustCardHeight);

        async function initialize() {
            try {
                const response = await fetch('default-questions.json');
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸ä½³');
                const questions = await response.json();
                addBank('default-questions', questions);
                localLoadStatus.textContent = 'â“˜ å·²æˆåŠŸåŠ è½½æœ¬åœ°é»˜è®¤é¢˜åº“ã€‚';
            } catch (error) {
                console.warn('æ— æ³•åŠ è½½æœ¬åœ°é»˜è®¤é¢˜åº“:', error);
                localLoadStatus.textContent = 'â“˜ æœªæ‰¾åˆ°æœ¬åœ°é»˜è®¤é¢˜åº“ (default-questions.json)ï¼Œè¯·é€šè¿‡ä¸Šæ–¹æŒ‰é’®å¯¼å…¥ã€‚';
            } finally {
                updateBankSelector();
                displayQuestion();
            }
        }

        initialize();
    });
</script>
</body>
</html>

